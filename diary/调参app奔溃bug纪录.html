<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>调参app奔溃bug纪录</title>

  	<link rel="stylesheet" href="templates/SyntaxHighlighter.css"></link>
	<link rel="stylesheet" href="templates/style.css">
	
	<script	src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script language="javascript" src="templates/shCore.js"></script>
	<script language="javascript" src="templates/shBrushCpp.js"></script>
	<script language="javascript" src="templates/shBrushJScript.js"></script>
	<script language="javascript" src="templates/shBrushPhp.js"></script>
	<script language="javascript" src="templates/shBrushJava.js"></script>
	<script language="javascript" src="templates/shBrushXml.js"></script>
	<script language="javascript" src="templates/shBrushCss.js"></script>
	<script language="javascript" src="templates/shBrushObjectiveC.js"></script>
	
	<script language="javascript" src="templates/vimwiki.js"></script>
</head>


<body>
    <div class="navbar">
      <div class="navbar-container">
	  <a class="brand" href="index.html">NieNet</a>
	  <div class="nav-collapse">
		<ul class="nav">
		  <li><a href="index.html">主页</a></li>
		  <li><a href="about.html">关于</a></li>
		</ul>
	  </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
	<div id="content">
	
<p>
这里纪录调参app开发中几个奔溃bug，这些bug或者有典型性，或者花费了很大的精力，当引以为戒。
</p>

<h2 id="toc_0.1">内存消耗殆尽</h2>
<p>
bug描述：在view页面，长期放置，则会出现拖动迟钝的问题，最后导致整个app奔溃；
</p>

<p>
bug调试过程：
</p>
<ul>
<li>
使用工具Xcode盒Instruments跟踪view页面内存泄漏，结果未发现有泄漏内存；

<li>
使用Organizer导出奔溃的crash文件，可以看到，确实是View页面导致内存耗尽引起的系统将调参app停止；

<li>
跟踪view页面的代码，发现是在<code> - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath</code>中存在cell申请了而不使用，重新申请新的内存，这样就导致了view页面反复申请cell对象而不使用，结果内存就消耗殆尽；

</ul>

<p>
教训：在tableView页面，cell的使用一定要注意，很容易出现各种问题；
</p>

<h2 id="toc_0.2">foreach循环中删除了数组元素</h2>
<p>
bug描述：在device list页面，当出现多个主控的时候，就可能出现奔溃的问题；
</p>

<p>
bug调试过程：
</p>
<ul>
<li>
联机调试，发现下面这样一段错误信息。
<pre name="code" class="c">
[9737:907] *** Terminating app due to uncaught exception 'NSGenericException', reason: '*** Collection &lt;__NSArrayM: 0x2005ca50&gt; was mutated while being enumerated.'
*** First throw call stack:
(0x38eeb2a3 0x3721597f 0x38eead85 0xb7e9b 0x3a9cd74b 0x38ec05df 0x38ec0291 0x38ebef01 0x38e31ebd 0x38e31d49 0x37c682eb 0x3a4032f9 0xaf337 0xaf2d8)
libc++abi.dylib: terminate called throwing an exception
</pre>

</ul>

<p>
教训：
</p>
<ul>
<li>
这个bug花费了不少时间，主要有几个原因：一是不知道这个提示信息基本上就是对应foreach循环；二是bug复现比较难，而且寻找的范围广，担心是通信库中的代码问题；

<li>
foreach循环中不能够增删数组元素，下面代码是不正确的：
<pre name="code" class="c">
    //使用_scanMainCtrlPerpherils的结果更新_mainCtrlPerpherils
    BOOL isScaned;
    int count = [self.MainCtrlPerpherals count];
    for(MainControllerPeripheral* mc in self.MainCtrlPerpherals){
	isScaned = NO;
	MainControllerPeripheral* mc = [self.MainCtrlPerpherals objectAtIndex:iter];
	
	for (MainControllerPeripheral* newMc in self.scanMainCtrlPerpherils) {
	    if ([mc.hardwareID isEqualToData:newMc.hardwareID]) {
		//同一个主控，在新的一次扫瞄中又扫到
		isScaned = YES;
		break;
	    }
	}
	
	if (NO == isScaned) {
	    //该主控在新的一次扫瞄中不存在，则删除
	    NSLog(@"delete ble");
	    [self.MainCtrlPerpherals removeObject:mc];
	}
    }
</pre>

</ul>

<h2 id="toc_0.3">standardUserDefaults返回的对象都是immutable</h2>
<p>
bug描述：app在实地调参之后，奔溃了
</p>

<p>
bug调试过程：
</p>
<ul>
<li>
使用Organizer导出奔溃的crash文件，并且反汇编符号化，可以看到代码出错的函数。跟踪改函数，可以看到如此下面的异常提示：
<pre name="code" class="c">
Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: '-[__NSCFArray insertObject:atIndex:]: mutating method sent to immutable object'
</pre>

</ul>

<p>
教训：
</p>
<ul>
<li>
需要学会使用app的crash log纪录来跟踪奔溃问题

<li>
standardUserDefaults返回的对象都是immutable，虽然将返回指针付给了NSMutableArray类型的指针；
<pre name="code" class="c">
 NSMutableArray * activeMainCtrl = [[NSUserDefaults standardUserDefaults] objectForKey:@"activeMainCtrl"];		//activeMainCtrl是immutable的
 NSMutableArray* activeMainCtrl = [NSMutableArray arrayWithArray:[[NSUserDefaults standardUserDefaults] objectForKey:KEY_STATISTICMAINCTL]];			//activeMainCtrl是mutable的
</pre>

</ul>

	</div>
    </div>

    <footer>
	<p id="legal">Copyright &copy; 2012 NIE-YONG. All Rights Reserved.</p>
    </footer>

    <a class="go2top" style="display: none;"><span></span></a>

</body>


<script language="javascript">
dp.SyntaxHighlighter.HighlightAll('code');
</script>

</html>

