<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>2012-12-28</title>

  	<link rel="stylesheet" href="templates/SyntaxHighlighter.css"></link>
	<link rel="stylesheet" href="templates/style.css">
	
	<script	src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script language="javascript" src="templates/shCore.js"></script>
	<script language="javascript" src="templates/shBrushCpp.js"></script>
	<script language="javascript" src="templates/shBrushJScript.js"></script>
	<script language="javascript" src="templates/shBrushPhp.js"></script>
	<script language="javascript" src="templates/shBrushJava.js"></script>
	<script language="javascript" src="templates/shBrushXml.js"></script>
	<script language="javascript" src="templates/shBrushCss.js"></script>
	<script language="javascript" src="templates/shBrushObjectiveC.js"></script>
	
	<script language="javascript" src="templates/vimwiki.js"></script>
</head>


<body>
    <div class="navbar">
      <div class="navbar-container">
	  <a class="brand" href="index.html">NieNet</a>
	  <div class="nav-collapse">
		<ul class="nav">
		  <li><a href="index.html">主页</a></li>
		  <li><a href="about.html">关于</a></li>
		</ul>
	  </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
	<div id="content">
	
<h3 id="toc_0.0.1">蓝牙问题报告2</h3>
<p>
1.can总线无法发出数据的问题
dji的设计中，主控，蓝牙，电台等是挂在can总线上，所有的通信都是通过can总线；
</p>

<p>
测试了连续发包导致无法收到ack报文，ble蓝牙断开等问题
</p>

<p>
测试了touch连续发包（也就是调参软件的view等页面的通信需求），导致无法收到ack报文，ble断开的问题。结果是can总线上无法测试到主控发出的ack报文，但是ble通过can总线发给主控的信息仍然能够测到。
</p>

<p>
这样基本可以肯定是can总线，或者主控出了问题；暂时未找到导致该问题的原因；
</p>


<p>
2.主控扫描失败率高的问题
在对某个蓝牙进行测试时，出现了扫描失败率高的问题，失败率达到30％以上；
</p>

<p>
该问题具体来说是在连接上ble之后，无法获取ble的device信息，导致无法扫描到主控；最后确定是ble蓝牙模块的问题，可能是该蓝牙的硬件设计，天线设计等问题，在以后的量产，封装设计等方面，肯定需要考虑和测试该问题；
</p>

<p>
在这里记下备忘；
</p>

<p>
3.断开ble连接的问题
</p>

<p>
使用ios的库函数cancelPeripheralConnection断开一个主控的连接时，需要等待一段时间（5s以上），并且不一定能够成功。
</p>

<p>
dji工程师设计了另外一个断开的办法，直接对ble的特征（0x33ff）写入字符xp，由ble上的软件控制断开连接。
</p>

<p>
该方法已经写入了通信库中，但是如果出现上面2所提到的主控扫描失败率高的问题时，就可能再也无法断开该ble主控，需要等待使用ios库函数cancelPeripheralConnection来断开连接；
</p>


<h3 id="toc_0.0.2">蓝牙问题报告3</h3>
<p>
对于报告2中的“2.主控扫描失败率高的问题，3.断开ble连接的问题”的补充和修正：
</p>

<p>
今天将新的通信库继承到调参软件后测试发现，使用了dji工程师提供的断开方式之后（直接对ble的特征0x33ff写入字符xp），主控的连接失败率会很高。
</p>

<p>
调试发现，主控连接失败率高的原因还是出在无法获得device信息，和主控扫描失败率高存在同样的地方（ios的库级别）。
</p>

<p>
最后删除了对0x33ff特征的直接写。
</p>

<p>
一些结论和思考：
1.出现该问题的原因猜测：ios的蓝牙库和蓝牙fireware的内部断开是重复的，可能导致了一些不可控制的问题。例如直接对特征0x33ff写入字符xp之后，ios库并不知道ble内部已经自动断开了，所以出现了问题；
2.建议我们的蓝牙模块的设计，参考了苹果公司发布的《Bluetooth Accessory Design Guidelines for Apple Products》；
</p>

	</div>
    </div>

    <footer>
	<p id="legal">Copyright &copy; 2012 NIE-YONG. All Rights Reserved.</p>
    </footer>

    <a class="go2top" style="display: none;"><span></span></a>

</body>


<script language="javascript">
dp.SyntaxHighlighter.HighlightAll('code');
</script>

</html>

